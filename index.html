<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Productos - Bsale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <style>
    header {
      height: auto;
      z-index: 4;
    }
    main {
      min-height: 100vh;
    }
    .nav-item {
      font-size: 18px;
      text-transform: uppercase;
    }
    .nav-item:hover {
      background-color: gray;
    }
    .nav-item:active {
      background-color: gray;
    }
    .sidebar {
      height: auto;
      margin-top: 5em;
    }
    .card {
      height: 100%;
    }
    .bd-placeholder-img {
      height: 100%;
    }
    .loader {
      top: 50%;
      left: 50%;
      right: 50%;
      bottom: 50%;
    }

  </style>
<body class="d-block">
    <header class="md:p-5 bg-dark text-white position-fixed w-100 mt-0">
        <div class="container">
          <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
            <ul class="nav col-12 col-md-6 col-lg-auto me-lg-auto mb-2 justify-content-center items-center">
              <li><a href="#" class="nav-link px-2 text-white font-bold text-xl">BSALE</a></li>
            </ul>
            <form class="col-12 col-md-6 col-lg-6 mb-3 mb-lg-0 me-lg-3">
              <input type="search" class="form-control form-control-dark" placeholder="Search..." aria-label="Search" id="idSearchProduct">
            </form>
            <div class="text-end">
            </div>
          </div>
        </div>
    </header>
    <main class="grid grid-cols-12 w-100">
      <aside class="hidden md:flex md:flex-col sidebar bg-gray-400 md:col-span-3 xl:col-span-2 p-4">
          <a href="#" class="pointer-events-none">
            <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"></use></svg>
            <span class="fs-3">CATEGORIAS</span>
          </a>
          <hr>
          <ul class="nav flex-column mb-auto" id="idCategories">
            <li class="">
              <a href="#0" class="nav-link active text-white fw-bolder bg-gray-700 hover:bg-gray-700 uppercase itemCategory">
                Todos
              </a>
              <hr>
            </li>
          </ul>
          <hr>
      </aside>
      <div class="bg-info flex-shrink-0 p-4 col-span-12 md:col-span-9 xl:col-span-10 bg-white p-5 mt-5">
        <input class="hidden" name="category" id="idCategory" value="0"/>
        <div class="relative inline-block text-left w-100 mt-5 space-y-2 sm:flex">
          <div class="flex flex-col space-y-2 w-100 sm:w-50">
            <div class="flex md:hidden items-center w-100 sm:w-50">
              <label class="mr-4">Categorias: </label>
              <div class="dropdown relative inline-block text-right w-auto">
                  <button type="button" class="inline-flex justify-center capitalize w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500" itype="button" data-toggle="dropdown" aria-expanded="false">
                    <label id="idCatActual">Todos</label>
                    <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </button>
                <div class="dropdown-menu z-10 hidden origin-top-right absolute right-0 mt-1 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu"    aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1" id="">
                  <div class="py-1" role="none" id="idCategoriesMobile">
                    <a href="#0" class="text-gray-700 block px-4 py-2 text-sm itemCategory" tabindex="-1" id="menu-item-0">Todos</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex items-center w-100 sm:w-50">
              <label class="mr-4 w-auto">Filtrar por: </label>
              <div class="dropdown relative inline-block text-right w-auto">
                  <button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500" itype="button" data-toggle="dropdown" aria-expanded="false">
                    <span id="idFilterActual">Recomendado</span>
                    <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </button>
                <div class="dropdown-menu z-10 hidden origin-top-right absolute right-0 mt-1 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu"    aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1" id="idFilterItems">
                  <div class="py-1" role="none">
                    <a href="#All" class="text-gray-700 block px-4 py-2 text-sm filteritem" tabindex="-1" id="menu-item-0">Recomendado</a>
                    <a href="#NameASC" class="text-gray-700 block px-4 py-2 text-sm filteritem" tabindex="-1" id="menu-item-0">Por nombre (A-Z)</a>
                    <a href="#NameDESC" class="text-gray-700 block px-4 py-2 text-sm filteritem" tabindex="-1" id="menu-item-1">Por nombre (Z-A)</a>
                    <a href="#PriceASC" class="text-gray-700 block px-4 py-2 text-sm filteritem" tabindex="-1" id="menu-item-2">Por precio menor a mayor</a>
                    <a href="#PriceDESC" class="text-gray-700 block px-4 py-2 text-sm filteritem" tabindex="-1" id="menu-item-2">Por precio mayor a menor</a>
                  </div>
                </div>
                <input value="All" name="filteractual" id="filterValue" class="hidden"/>
              </div>
            </div>
          </div>
          <div class="grid w-100 sm:w-50 justify-items-end">
            <nav aria-label="Page navigation example">
              <ul class="pagination idPaginacion">
              </ul>
            </nav>
          </div>
        </div>
        <div class="h-75" id="idSpinner">
          <div class="spinner-border text-primary relative mb-4 inset-y-1/2 inset-x-1/2" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div class="w-100 text-center mt-5 justify-center hidden" id="idErrorLoading">
          <span>Hubo un error</span>
        </div>
        <div class="mt-4 grid grid-cols-1 gap-y-10 gap-x-6 mb-4 sm:grid-cols-2 xl:grid-cols-4 xl:gap-x-8" style="width: 100%; margin-top: 10em;" id="idProducts">
        </div>
        <div class="grid w-100 sm:w-50 justify-items-end">
          <nav aria-label="Page navigation example">
            <ul class="pagination idPaginacion">
            </ul>
          </nav>
        </div>
      </div>
    </main>
    
    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <script>

      const remote_host = "https://bsale-test-server.herokuapp.com";
      const css_pag_active =
        "z-10 bg-indigo-50 border-indigo-500 text-indigo-600 border-2 py-2 px-3 xl:px-4 text-sm";
      const css_pag_no_active =
        "border hover:bg-gray-300 py-2 px-3 xl:px-4 text-sm text-gray-900";
      const css_categori_no_active =
        "nav-link active text-white fw-bolder hover:bg-gray-700 uppercase itemCategory";
      
      function errorImage(e) {
        console.log(e);
        e.src = './img/image-not-found.png'
      }
      function listCategories(api) {
        $.ajax({
          type: "GET",
          url: api,
          success: function (data) {
            $.each(data, (index, cat) => {
              $("#idCategories").append(`
                  <li class="nav-item">
                  <a href="#${cat.idcategory}" class="nav-link active text-white fw-bolder hover:bg-gray-700 uppercase itemCategory">
                      ${cat.name}
                  </a>
                  </li>
                  `);
              $("#idCategoriesMobile").append(`
                  <a href="#${cat.idcategory}" class="text-gray-700 block px-4 py-2 text-sm capitalize itemCategory mobile" tabindex="-1">${cat.name}</a>
              `);
            });
          },
          error: (error) => {
            console.log("Hubo un error");
          },
        });
      }

      function loadProducts(data) {
        var icon_cart = `
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
                    <path d="M14 36c-2.21 0-3.98 1.79-3.98 4s1.77 4 3.98 4 4-1.79 4-4-1.79-4-4-4zm-12-32v4h4l7.19 15.17-2.7 
                      4.9c-.31.58-.49 1.23-.49 1.93 0 2.21 1.79 4 4 4h24v-4h-23.15c-.28 0-.5-.22-.5-.5 0-.09.02-.17.06-.24l1.79-3.26h14.9c1.5 
                      0 2.81-.83 3.5-2.06l7.15-12.98c.16-.28.25-.61.25-.96 0-1.11-.9-2-2-2h-29.57l-1.9-4h-6.53zm32 32c-2.21 0-3.98 1.79-3.98 4s1.77 
                      4 3.98 4 4-1.79 4-4-1.79-4-4-4z"/><path fill="none" d="M0 0h48v48h-48z"/>
                  </svg>
                `;
        data.map((pro) => {
          $("#idProducts").append(`
              <div class="group relative bg-gray-50 p-3">
              <div class="w-auto min-h-80 bg-white aspect-w-1 aspect-h-1 rounded-md overflow-hidden group-hover:opacity-75 lg:h-80 lg:aspect-none">
                  <img src="${pro.urlImage}" onerror="errorImage(this)" class="w-full h-full object-center object-contain lg:w-full lg:h-full">
                  <div class="absolute right-8 lg:right-10 top-50 md:top-54 lg:top-60">
                  ${
                    pro.discount > 0
                      ? '<p class="text-lg font-bold text-gray-700 rounded-full bg-gray-200 w-12 pl-1 pr-2 py-2 text-center">' +
                        pro.discount +
                        "%</p>"
                      : ""
                  }
                  </div>
              </div>
              <div class="mt-4 flex justify-between">
                  <div>
                  <h3 class="text-sm text-gray-700">
                      <a href="#">
                      <span aria-hidden="true" class="absolute inset-0"></span>
                      ${pro.name}
                      </a>
                  </h3>
                  <p class="mt-1 text-xl font-medium text-black">$${pro.price}</p>
                  </div>
                  <div class="block text-center">
                  <p class="text-sm font-bold text-red-900">${icon_cart}</p>
                  </div>
              </div>
              </div>
          `);
          $("#idSpinner").css("display", "none");
        });
      }

      function loadPagination(pages) {
        if(pages > 1){
          for (var i = 1; i < pages + 1; i++) {
            $(".idPaginacion").append(
              `<li class='page-item'><button class='${
                i == 1 ? css_pag_active : css_pag_no_active
              }' id='idNumPage'>${i}</button></li>`
            );
          }
        }
      }

      function listProducts(api, cat, filter, page, loadPages) {
        console.log(
          "properties: api,page,filter,cat: ",
          `${api}?page=${page}&cat=${cat}&type=${filter}`
        );
        $("#idProducts").empty();
        $("#idSpinner").css("display", "flex");
        $("#idErrorLoading").css("display", "none");
        $("#idErrorLoading").empty();
        $.ajax({
          type: "GET",
          url: `${api}?cat=${cat}&page=${page}&type=${filter}`,
          success: function (data) {
            loadProducts(data.content);
            if (data.length < 1) {
              $("#idSpinner").css("display", "none");
              $("#idErrorLoading").css("display", "flex");
              $("#idErrorLoading").html(`<span>No hay productos registrados</span>`);
            }
            if (loadPages) loadPagination(data.totalPages);
          },
          error: (error) => {
            console.log("Hubo un error", error);
            $("#idSpinner").css("display", "none");
            $("#idErrorLoading").css("display", "flex");
            $("#idErrorLoading").html(`<span>Hubo un error al consultar los productos</span>`);
          },
        });
      }

      function listProductsByName(api, name) {
        $("#idProducts").empty();
        $(".idPaginacion").empty();
        $("#idErrorLoading").empty();
        $("#idSpinner").css("display", "flex");
        $("#idErrorLoading").css("display", "none");
        $.ajax({
          type: "GET",
          url: `${api}?name=${name}`,
          success: function (data) {
            loadProducts(data);
            if (data.length < 1) {
              $("#idSpinner").css("display", "none");
              $("#idErrorLoading").css("display", "flex");
              $("#idErrorLoading").html(`<span>No hay ningun producto con ese nombre</span>`);
            }
          },
          error: (error) => {
            console.log(error);
            $("#idSpinner").css("display", "none");
            $("#idErrorLoading").css("display", "flex");
            $("#idErrorLoading").html(`<span>Hubo un error al consultar</span>`);
          },
        });
      }

      $(document).on("click", ".itemCategory", function () {
        const element = $(this);
        const idCat = element.attr("href").replace("#", "");

        const class_cat = $(this).attr("class").includes("mobile");

        if (!class_cat) {
          $(".itemCategory").attr("class", css_categori_no_active);
          element.attr("class", css_categori_no_active + " bg-gray-700 text-white");
        }

        $("#idCategory").val(idCat);
        $("#idCatActual").text(element.text());
        $("#idFilterActual").text("Recomendado");

        $(".idPaginacion").empty();
        const api_product = `${remote_host}/api/product/filter`;
        listProducts(api_product, idCat, "All", 0, true);
      });

      $(document).on("click", "#idNumPage", function () {
        $(".idPaginacion li button").attr("class", css_pag_no_active);

        const page = parseInt($(this).text()) - 1;
        $(".idPaginacion > li > button").map((index, btn) => {
          console.log();
          if ($(btn).text() == page + 1) {
            $(btn).attr("class", css_pag_active);
          }
        });
        const api_product = `${remote_host}/api/product/filter`;
        listProducts(
          api_product,
          $("#idCategory").val(),
          $("#filterValue").text(),
          page,
          false
        );
      });

      $(document).ready(function () {
        const api_category = `${remote_host}/api/category/`;
        const api_product = `${remote_host}/api/product/listAll`;

        listCategories(api_category);
        listProducts(api_product, 0, "All", 0, true);

        $(".filteritem").click(function () {
          const element = $(this);
          var attr_val = $(this).attr("href").replace("#", "");
          var cat_val = $("#idCategory").val();

          $("#idFilterActual").text(element.text());
          $("#filterValue").val(attr_val);
          $(".idPaginacion").empty();

          const api = `${remote_host}/api/product/filter`;
          listProducts(api, cat_val, attr_val, 0, true);
        });

        $("#idSearchProduct").keyup(function (e) {
          const api = `${remote_host}/api/product/listByName`;
          console.log(e.target.value);
          if(e.target.value.trim().length > 0){
            listProductsByName(api, e.target.value);
          }else{
            listProducts(api_product, 0, "All", 0, true);
          }
        });
      });

    </script>
</body>
</html>